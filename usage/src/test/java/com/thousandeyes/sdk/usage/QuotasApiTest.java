/*
 * Usage API
 *  These usage endpoints define the following operations:  * **Usage**: Retrieve usage data for the specified time period (default is one month).          * Users must have the `View organization usage` permission to access this endpoint.     * This operation offers visibility across all account groups within the organization.     * Users with `View organization usage` permission in multiple organizations should query the operation with the `aid` query string parameter (see optional parameters) for each organization.     * The `agentId` field in enterprise agent unit responses may be omitted when not available.  * **Quotas**: Obtain organization and account usage quotas. Additionally, users with the appropriate permissions can create, update, or delete these quotas.          * Users must have the necessary permissions to perform quota-related actions.  Refer to the Usage API operations for detailed usage instructions and optional parameters. 
 *
 * 
 *
 * NOTE: This class is auto generated by OpenAPI Generator (https://openapi-generator.tech).
 * https://openapi-generator.tech
 * Do not edit the class manually.
 */


package com.thousandeyes.sdk.usage;

import com.thousandeyes.sdk.usage.model.Error;
import com.thousandeyes.sdk.usage.model.OrganizationsQuotasAssign;
import com.thousandeyes.sdk.usage.model.OrganizationsQuotasUnassign;
import com.thousandeyes.sdk.usage.model.Quotas;
import com.thousandeyes.sdk.usage.model.QuotasAssignRequest;
import com.thousandeyes.sdk.usage.model.QuotasAssignResponse;
import com.thousandeyes.sdk.usage.model.QuotasUnassign;
import com.thousandeyes.sdk.usage.model.UnauthorizedError;
import com.thousandeyes.sdk.usage.model.ValidationError;
import static com.github.tomakehurst.wiremock.client.WireMock.*;
import static com.github.tomakehurst.wiremock.common.ContentTypes.AUTHORIZATION;
import static com.github.tomakehurst.wiremock.common.ContentTypes.CONTENT_TYPE;
import static com.thousandeyes.sdk.serialization.JSON.getDefault;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;

import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;

import com.fasterxml.jackson.core.JsonProcessingException;

import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.github.tomakehurst.wiremock.junit5.WireMockRuntimeInfo;
import com.github.tomakehurst.wiremock.junit5.WireMockTest;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

import com.thousandeyes.sdk.client.ApiClient;
import com.thousandeyes.sdk.client.ApiException;
import com.thousandeyes.sdk.client.NativeApiClient;


/**
 * Request and Response model deserialization tests for QuotasApi
 */
@WireMockTest
public class QuotasApiTest {
    private static final String TOKEN = "valid-token";
    private static final String BEARER_TOKEN = "Bearer %s".formatted(TOKEN);
    private static QuotasApi api;
    private final ObjectMapper mapper = getDefault()
            .getMapper()
            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, true);

    @BeforeAll
    public static void setup(WireMockRuntimeInfo wireMockRuntimeInfo) {
        ApiClient client = NativeApiClient.builder()
                                .baseUri(wireMockRuntimeInfo.getHttpBaseUrl())
                                .bearerToken(TOKEN)
                                .build();
        api = new QuotasApi(client);
    }
    
    /**
     * Create or update accout group quotas
     * <p>
     * This operation assigns quota values to multiple account groups across multiple organizations. To use this endpoint, you need the &#x60;Edit organization and account group quotas&#x60; permission, which is a management-level permission. This operation follows a cumulative behavior––This means that the quotas are assigned to the designated account groups, and any previous assignments remain in place without any unassignment occurring.
     *
     * @throws JsonProcessingException if the deserialization fails
     */
    @Test
    public void assignOrganizationsAccountGroupsQuotasRequestAndResponseDeserializationTest()
            throws JsonProcessingException, ApiException
    {

        var requestBodyJson = """
                {
                  "organizations" : [ {
                    "orgId" : "1234",
                    "accountGroups" : [ {
                      "value" : 12000,
                      "aid" : "1234"
                    }, {
                      "value" : 12000,
                      "aid" : "1234"
                    } ]
                  }, {
                    "orgId" : "1234",
                    "accountGroups" : [ {
                      "value" : 12000,
                      "aid" : "1234"
                    }, {
                      "value" : 12000,
                      "aid" : "1234"
                    } ]
                  } ]
                }
                                 """;
        var requestBodyContentType = "application/json";
        OrganizationsQuotasAssign mappedRequest = 
                mapper.readValue(requestBodyJson, OrganizationsQuotasAssign.class);
        assertNotNull(mappedRequest);

        var responseBodyJson = """
                {
                  "organizations" : [ {
                    "orgId" : "1234",
                    "accountGroups" : [ {
                      "value" : 12000,
                      "aid" : "1234"
                    }, {
                      "value" : 12000,
                      "aid" : "1234"
                    } ]
                  }, {
                    "orgId" : "1234",
                    "accountGroups" : [ {
                      "value" : 12000,
                      "aid" : "1234"
                    }, {
                      "value" : 12000,
                      "aid" : "1234"
                    } ]
                  } ]
                }
                                  """;
        var statusCode = 200;
        var responseContentType = "application/json";
        OrganizationsQuotasAssign mappedResponse = 
                mapper.readValue(responseBodyJson, OrganizationsQuotasAssign.class);
        assertNotNull(mappedResponse);

        var path = "/quotas/account-groups/assign";
        stubFor(post(urlPathTemplate(path))
                        .withHeader(AUTHORIZATION, equalTo(BEARER_TOKEN))
                        .withHeader(CONTENT_TYPE, equalTo(requestBodyContentType))
                        .withRequestBody(equalToJson(requestBodyJson))
                        .willReturn(aResponse()
                                            .withHeader(CONTENT_TYPE, responseContentType)
                                            .withBody(responseBodyJson)
                                            .withStatus(statusCode)));

        var apiResponse = api.assignOrganizationsAccountGroupsQuotas(mappedRequest);
        assertEquals(mappedResponse, apiResponse);
    }
    
    /**
     * Create or update organizations quotas
     * <p>
     * This operation recieves a list of organization quotas to create or update. If there&#39;s no specific &#x60;orgId&#x60; defined for a quota, it defaults to using the authenticated organization. To use this endpoint, you need the &#x60;Edit organization and account group quotas&#x60; permission, which is a management-level permission. This operation follows cumulative behavior––This means that the quotas are assigned to the specified organizations, and any previous assignments remain unchanged; no unassignments occur.
     *
     * @throws JsonProcessingException if the deserialization fails
     */
    @Test
    public void assignOrganizationsQuotasRequestAndResponseDeserializationTest()
            throws JsonProcessingException, ApiException
    {

        var requestBodyJson = """
                {
                  "organizations" : [ {
                    "value" : 12000
                  }, {
                    "orgId" : "1234",
                    "value" : 10000
                  } ]
                }
                                 """;
        var requestBodyContentType = "application/json";
        QuotasAssignRequest mappedRequest = 
                mapper.readValue(requestBodyJson, QuotasAssignRequest.class);
        assertNotNull(mappedRequest);

        var responseBodyJson = """
                {
                  "organizations" : [ {
                    "orgId" : "1234",
                    "value" : 12000
                  }, {
                    "orgId" : "12345",
                    "value" : 10000
                  } ]
                }
                                  """;
        var statusCode = 200;
        var responseContentType = "application/json";
        QuotasAssignResponse mappedResponse = 
                mapper.readValue(responseBodyJson, QuotasAssignResponse.class);
        assertNotNull(mappedResponse);

        var path = "/quotas/assign";
        stubFor(post(urlPathTemplate(path))
                        .withHeader(AUTHORIZATION, equalTo(BEARER_TOKEN))
                        .withHeader(CONTENT_TYPE, equalTo(requestBodyContentType))
                        .withRequestBody(equalToJson(requestBodyJson))
                        .willReturn(aResponse()
                                            .withHeader(CONTENT_TYPE, responseContentType)
                                            .withBody(responseBodyJson)
                                            .withStatus(statusCode)));

        var apiResponse = api.assignOrganizationsQuotas(mappedRequest);
        assertEquals(mappedResponse, apiResponse);
    }
    
    /**
     * Get organization and account group usage quota
     * <p>
     * This operation retrieves usage quotas for both organization and account groups. To use this endpoint, you need the &#x60;Edit organization and account group quotas&#x60; permission, which is a management-level permission. If a user has quota update permission in multiple organizations, the API returns data from all such organizations.
     *
     * @throws JsonProcessingException if the deserialization fails
     */
    @Test
    public void getQuotasRequestAndResponseDeserializationTest()
            throws JsonProcessingException, ApiException
    {


        var responseBodyJson = """
                {
                  "quotas" : [ {
                    "accountGroupQuotas" : [ {
                      "value" : 12000,
                      "aid" : "1234"
                    }, {
                      "value" : 10000,
                      "aid" : "12345"
                    } ],
                    "organizationQuota" : {
                      "value" : 22500,
                      "orgId" : "10"
                    }
                  }, {
                    "accountGroupQuotas" : [ {
                      "value" : 12000,
                      "aid" : "1234"
                    }, {
                      "value" : 10000,
                      "aid" : "12345"
                    } ],
                    "organizationQuota" : {
                      "value" : 22500,
                      "orgId" : "10"
                    }
                  } ],
                  "_links" : {
                    "self" : {
                      "hreflang" : "hreflang",
                      "templated" : true,
                      "profile" : "profile",
                      "name" : "name",
                      "href" : "https://api.thousandeyes.com/v7/link/to/resource/id",
                      "type" : "type",
                      "deprecation" : "deprecation",
                      "title" : "title"
                    }
                  }
                }
                                  """;
        var statusCode = 200;
        var responseContentType = "application/json";
        Quotas mappedResponse = 
                mapper.readValue(responseBodyJson, Quotas.class);
        assertNotNull(mappedResponse);

        var path = "/quotas";
        stubFor(get(urlPathTemplate(path))
                        .withHeader(AUTHORIZATION, equalTo(BEARER_TOKEN))
                        .willReturn(aResponse()
                                            .withHeader(CONTENT_TYPE, responseContentType)
                                            .withBody(responseBodyJson)
                                            .withStatus(statusCode)));

        var apiResponse = api.getQuotas();
        assertEquals(mappedResponse, apiResponse);
    }
    
    /**
     * Remove account group quotas from organizations
     * <p>
     * This operation removes quotas from multiple account groups across multiple organizations. To use this endpoint, you need the &#x60;Edit organization and account group quotas&#x60; permission, which is a management-level permission.
     *
     * @throws JsonProcessingException if the deserialization fails
     */
    @Test
    public void unassignOrganizationsAccountGroupsQuotasRequestAndResponseDeserializationTest()
            throws JsonProcessingException, ApiException
    {

        var requestBodyJson = """
                {
                  "organizations" : [ {
                    "orgId" : "1234",
                    "accountGroups" : [ "1234", "12345" ]
                  }, {
                    "orgId" : "1234",
                    "accountGroups" : [ "1234", "12345" ]
                  } ]
                }
                                 """;
        var requestBodyContentType = "application/json";
        OrganizationsQuotasUnassign mappedRequest = 
                mapper.readValue(requestBodyJson, OrganizationsQuotasUnassign.class);
        assertNotNull(mappedRequest);

        var statusCode = 204;

        var path = "/quotas/account-groups/unassign";
        stubFor(post(urlPathTemplate(path))
                        .withHeader(AUTHORIZATION, equalTo(BEARER_TOKEN))
                        .withHeader(CONTENT_TYPE, equalTo(requestBodyContentType))
                        .withRequestBody(equalToJson(requestBodyJson))
                        .willReturn(aResponse()
                                            .withStatus(statusCode)));

        var apiResponse = api.unassignOrganizationsAccountGroupsQuotasWithHttpInfo(mappedRequest);
        assertEquals(statusCode, apiResponse.getStatusCode());
    }
    
    /**
     * Remove organization quotas
     * <p>
     * This operation recieves a list of organization IDs to remove their current quota. To use this endpoint, you need the &#x60;Edit organization and account group quotas&#x60; permission, which is a management-level permission.
     *
     * @throws JsonProcessingException if the deserialization fails
     */
    @Test
    public void unassignOrganizationsQuotasRequestAndResponseDeserializationTest()
            throws JsonProcessingException, ApiException
    {

        var requestBodyJson = """
                {
                  "organizations" : [ "1234", "12345" ]
                }
                                 """;
        var requestBodyContentType = "application/json";
        QuotasUnassign mappedRequest = 
                mapper.readValue(requestBodyJson, QuotasUnassign.class);
        assertNotNull(mappedRequest);

        var statusCode = 204;

        var path = "/quotas/unassign";
        stubFor(post(urlPathTemplate(path))
                        .withHeader(AUTHORIZATION, equalTo(BEARER_TOKEN))
                        .withHeader(CONTENT_TYPE, equalTo(requestBodyContentType))
                        .withRequestBody(equalToJson(requestBodyJson))
                        .willReturn(aResponse()
                                            .withStatus(statusCode)));

        var apiResponse = api.unassignOrganizationsQuotasWithHttpInfo(mappedRequest);
        assertEquals(statusCode, apiResponse.getStatusCode());
    }
    
}
